extends layout.pug

block pageName
  title Embedding VoteByMail.io
  meta(name="viewport", content="width=device-width, initial-scale=1.0")
  style.
    div > button {
      margin-right: 15px;
      margin-bottom: 15px;
    }

block content
  .container.mt-4
    h1 Embedding VoteByMail.io
    p This page guides you on creating embeddable versions of VoteByMail.io.  In order for these steps to be successful, you must be able to insert the iFrame into your page.  If using a Content Management System, like WordPress or Drupal, double-check that you're actually editing the raw content of the page and not using any WYSIWYG editor provided by these tools. Also, due to the safety measures adopted by modern browsers, your page must be HTTPS (not HTTP) for this to work.

    .row
      .col.col-lg-6.col-sm-12
        .card.mt-4.p-3
          .card-body
            h3 Anchor
            p Setting a HTML anchor will replace the default starting point of any web page, for example, in VoteByMail you can set an anchor to load the website from the "About Us" section.
            p.text-muted Setting a default state will replace this anchor, since the widget will start from the input address form.
            button(
              type='button'
              class='btn btn-primary'
              onClick="setAnchor('')"
            ) Default (top)
            button(
              type='button'
              class='btn btn-primary'
              onClick="setAnchor('#howItWorks')"
            ) How does it work?
            button(
              type='button'
              class='btn btn-primary'
              onClick="setAnchor('#getInvolved')"
            ) Get Involved
            button(
              type='button'
              class='btn btn-primary'
              onClick="setAnchor('#team')"
            ) Team
            button(
              type='button'
              class='btn btn-primary'
              onClick="setAnchor('#contact')"
            ) Contact Us
            button(
              type='button'
              class='btn btn-primary'
              onClick="setAnchor('#about')"
            ) About Us

      .col.col-lg-6.col-sm-12
        .card.mt-4.p-3
          .card-body
            h3 Widget configuration
            p Use these to prefill the default state and organization of your embedded widget.
            p.text-muted If you own or belong to an organization, they will be shown on the dropdown below for selection.
            label(for='prefill-state') Prefill State
            .input-group.mb-3
              select(
                id='prefill-state'
                class='form-control'
                aria-label='prefill state input'
                onChange=`setState(this.value)`
              )
                each state in states
                  option(
                    aria-label=state
                    value=state
                  )= state

            label(for='prefill-org') Prefill Organization
            .input-group.mb-3
              select(
                id='prefill-org'
                class='form-control'
                aria-label='prefill org input'
                onChange=`setOrg(this.value)`
              )
                //- Only add the default org option if the user doesn't own/belong to it.
                if richOrgs.find(function(org) { return org.id === 'default' }) === undefined
                  option(
                    aria-label='default org'
                    value='default'
                  ) Default
                each org in richOrgs
                  option(
                    aria-label=org.name ? `${org.name} (${org.id})` : org.id
                    value=org.id
                  )= org.name ? `${org.name} (${org.id})` : org.id

  .container.mt-4
    br
    h2 Widget code
    br
    p Please copy the text in red and add it to your website, the code in this block updates automatically as you edit your widget.
    textarea(
      name='vbm-iframe-code'
      id='vbm-iframe-code'
      style='display: block; width: 100%; padding: 10px; color: #dc0e52; background-color: #fafafa; margin: 25px 0; border-radius: 4px; resize: none;'
      resizable='false'
      disabled='true'
    )= env.REACT_APP_URL
    button(class='btn btn-primary' onClick='copyIframe()') Copy

    br
    h3 Preview
    p.text-muted The dashed red border indicates the available space for the widget.
    div(style='width: 100%; height: 1024px; border: 2px dashed #dc0e52;')
      iframe(
        id='vbm-iframe'
        src=`${env.REACT_APP_URL}/${org}`
        style='width: 100%; height: 100%;'
      )


  script.
    let org = '';
    const iframe = document.getElementById('vbm-iframe');
    const code = document.getElementById('vbm-iframe-code');
    // The initial value of code is env.REACT_APP_URL (we can't access env here)
    const baseUrl = code.value;
    let anchor = '';
    let state = '';

    function copyIframe() {
      // Select will only work if disabled is false
      code.disabled = false;
      code.select();
      document.execCommand('copy');
      code.disabled = true;
    }

    function updateCode() {
      // This is why our widget wasn't always updating, to see the changes we must first
      // clear the iframe.src and then (after a brief delay) load our url.
      iframe.src = '';
      setTimeout(
        function() {
          iframe.src = `${baseUrl}/${org}${anchor}${state}`;
          code.value = iframe.outerHTML;
        },
        100,
      );
    }

    function setOrg(oid) {
      org = `#/org/${oid ? oid : 'default'}`;
      updateCode();
    }

    function setAnchor(a) {
      anchor = a;
      updateCode();
    }

    function setState(s) {
      anchor = '';
      state = s !== 'No default state' ? `/address/${s}` : '';
      updateCode();
    }

    // Initialize default values
    setOrg(org);
